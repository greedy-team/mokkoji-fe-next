name: Dev Env (Start/Stop/Deploy)

on:
  workflow_dispatch:
    inputs:
      cmd:
        description: 'start | stop | restart | deploy'
        required: true
        default: 'start'

jobs:
  dev:
    runs-on: ubuntu-latest
    steps:
      - name: Run SSH command
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          envs: |
            WORK_DIR=${{ secrets.WORK_DIR || '/var/www/mokkoji' }}
            CMD=${{ github.event.inputs.cmd }}
          script: |
            set -e

            cd "$WORK_DIR"

            if [ "$CMD" = "start" ]; then
              git fetch --all
              git checkout dev
              git pull --ff-only

              if command -v pnpm >/dev/null 2>&1; then
                pnpm i --frozen-lockfile
                pnpm build
                pm2 describe mokkoji-dev >/dev/null 2>&1 || pm2 start "pnpm start -- -p 3001" --name mokkoji-dev
              else
                npm ci
                npm run build
                pm2 describe mokkoji-dev >/dev/null 2>&1 || pm2 start "npm run start -- -p 3001" --name mokkoji-dev
              fi

              pm2 save

            elif [ "$CMD" = "stop" ]; then
              pm2 stop mokkoji-dev || true
              pm2 delete mokkoji-dev || true
              pm2 save || true

            elif [ "$CMD" = "restart" ]; then
              pm2 restart mokkoji-dev

            elif [ "$CMD" = "deploy" ]; then
              git fetch --all
              git checkout dev
              git pull --ff-only

              if command -v pnpm >/dev/null 2>&1; then
                pnpm i --frozen-lockfile
                pnpm build
                pm2 restart mokkoji-dev || pm2 start "pnpm start -- -p 3001" --name mokkoji-dev
              else
                npm ci
                npm run build
                pm2 restart mokkoji-dev || pm2 start "npm run start -- -p 3001" --name mokkoji-dev
              fi

              pm2 save

            else
              echo "Unknown cmd: $CMD"
              exit 1
            fi
