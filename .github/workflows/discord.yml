name: GitHub â†’ Discord (Enhanced Embed Style)

on:
  issues:
    types: [opened, reopened]
  pull_request:
    types: [opened, merged, reopened]

jobs:
  discord-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Send Enhanced Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          EVENT_NAME=${{ github.event_name }}
          REPO_NAME="${{ github.repository }}"
          AUTHOR_NAME="${{ github.actor }}"
          AUTHOR_AVATAR="${{ github.event.sender.avatar_url }}"
          
          # ê¸°ë³¸ê°’ ì„¤ì •
          COLOR=9807270
          TITLE=""
          DESCRIPTION=""
          URL=""
          EMOJI=""
          
          # ì„¤ëª… ê¸¸ì´ ì œí•œ (200ì)
          truncate_description() {
            if [ ${#1} -gt 200 ]; then
              echo "${1:0:197}..."
            else
              echo "$1"
            fi
          }

          if [ "$EVENT_NAME" = "issues" ]; then
            ISSUE_ACTION="${{ github.event.action }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY=$(truncate_description "${{ github.event.issue.body }}")
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            URL="${{ github.event.issue.html_url }}"
            
            case "$ISSUE_ACTION" in
              "opened")
                COLOR=15844367  # ì£¼í™© (#F39C12)
                EMOJI="ğŸ†•"
                TITLE="ìƒˆë¡œìš´ ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
                DESCRIPTION="**#${ISSUE_NUMBER} ${ISSUE_TITLE}**\n\n${ISSUE_BODY}"
                ;;
              "closed")
                COLOR=10181046  # ë³´ë¼ (#9B59B6)
                EMOJI="âœ…"
                TITLE="ì´ìŠˆê°€ ë‹«í˜”ìŠµë‹ˆë‹¤"
                DESCRIPTION="**#${ISSUE_NUMBER} ${ISSUE_TITLE}**"
                ;;
              "reopened")
                COLOR=15844367  # ì£¼í™© (#F39C12)
                EMOJI="ğŸ”„"
                TITLE="ì´ìŠˆê°€ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤"
                DESCRIPTION="**#${ISSUE_NUMBER} ${ISSUE_TITLE}**\n\n${ISSUE_BODY}"
                ;;
            esac

          elif [ "$EVENT_NAME" = "pull_request" ]; then
            PR_ACTION="${{ github.event.action }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY=$(truncate_description "${{ github.event.pull_request.body }}")
            PR_NUMBER="${{ github.event.pull_request.number }}"
            SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
            TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
            URL="${{ github.event.pull_request.html_url }}"
            
            case "$PR_ACTION" in
              "opened")
                COLOR=3066993   # ì´ˆë¡ (#2ECC71)
                EMOJI="ğŸ”€"
                TITLE="ìƒˆë¡œìš´ Pull Requestê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
                DESCRIPTION="**#${PR_NUMBER} ${PR_TITLE}**\n\n\`${SOURCE_BRANCH}\` â†’ \`${TARGET_BRANCH}\`\n\n${PR_BODY}"
                ;;
              "closed")
                if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                  COLOR=8663711   # ì§„í•œ ì´ˆë¡ (#8E44AD)
                  EMOJI="ğŸ‰"
                  TITLE="Pull Requestê°€ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤!"
                else
                  COLOR=15158332  # ë¹¨ê°• (#E74C3C)
                  EMOJI="âŒ"
                  TITLE="Pull Requestê°€ ë‹«í˜”ìŠµë‹ˆë‹¤"
                fi
                DESCRIPTION="**#${PR_NUMBER} ${PR_TITLE}**\n\n\`${SOURCE_BRANCH}\` â†’ \`${TARGET_BRANCH}\`"
                ;;
              "reopened")
                COLOR=3066993   # ì´ˆë¡ (#2ECC71)
                EMOJI="ğŸ”„"
                TITLE="Pull Requestê°€ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤"
                DESCRIPTION="**#${PR_NUMBER} ${PR_TITLE}**\n\n\`${SOURCE_BRANCH}\` â†’ \`${TARGET_BRANCH}\`"
                ;;
            esac

          elif [ "$EVENT_NAME" = "push" ]; then
            BRANCH_NAME="${{ github.ref_name }}"
            COMMIT_MESSAGE=$(truncate_description "${{ github.event.head_commit.message }}")
            COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
            COMMITS_COUNT="${{ github.event.commits }}"
            URL="${{ github.event.compare }}"
            
            COLOR=3447003    # íŒŒë‘ (#3498DB)
            EMOJI="ğŸ“"
            TITLE="ìƒˆë¡œìš´ ì»¤ë°‹ì´ í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤!"
            DESCRIPTION="**ë¸Œëœì¹˜:** \`${BRANCH_NAME}\`\n**ì»¤ë°‹:** ${COMMIT_MESSAGE}\n**ì‘ì„±ì:** ${COMMIT_AUTHOR}"

          elif [ "$EVENT_NAME" = "release" ]; then
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            RELEASE_NAME="${{ github.event.release.name }}"
            RELEASE_BODY=$(truncate_description "${{ github.event.release.body }}")
            URL="${{ github.event.release.html_url }}"
            
            COLOR=16776960   # ê¸ˆìƒ‰ (#FFD700)
            EMOJI="ğŸš€"
            TITLE="ìƒˆë¡œìš´ ë¦´ë¦¬ì¦ˆê°€ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!"
            DESCRIPTION="**${RELEASE_TAG} - ${RELEASE_NAME}**\n\n${RELEASE_BODY}"
          fi

          # Discord Webhook ë°œì†¡ (í–¥ìƒëœ ì„ë² ë“œ)
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                     \"embeds\": [{
                       \"title\": \"${EMOJI} ${TITLE}\",
                       \"description\": \"${DESCRIPTION}\",
                       \"url\": \"${URL}\",
                       \"color\": ${COLOR},
                       \"author\": {
                         \"name\": \"${AUTHOR_NAME}\",
                         \"icon_url\": \"${AUTHOR_AVATAR}\"
                       },
                       \"fields\": [
                         {
                           \"name\": \"Repository\",
                           \"value\": \"[\`${REPO_NAME}\`](https://github.com/${REPO_NAME})\",
                           \"inline\": true
                         },
                         {
                           \"name\": \"Event\",
                           \"value\": \"\`${EVENT_NAME}\`\",
                           \"inline\": true
                         }
                       ],
                       \"footer\": {
                         \"text\": \"GitHub â†’ Discord\",
                         \"icon_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
                       },
                       \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                     }]
                   }" \
               "$DISCORD_WEBHOOK_URL"

          echo "âœ… Discord notification sent successfully for $EVENT_NAME event"