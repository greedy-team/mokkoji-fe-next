name: Debug Deploy

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest

    steps:
      - name: Debug SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          debug: true
          script: |
            set -ex

            echo "=== System Info ==="
            whoami
            pwd
            hostname

            echo ""
            echo "=== Checking directories ==="
            ls -la /var/www/ || echo "/var/www/ not found"
            ls -la /home/ || echo "Cannot list /home/"

            echo ""
            echo "=== Checking commands ==="
            which git || echo "git not found"
            which node || echo "node not found"
            which npm || echo "npm not found"
            which pnpm || echo "pnpm not found"
            which pm2 || echo "pm2 not found"

            echo ""
            echo "=== Node/NPM versions ==="
            node --version || echo "node not available"
            npm --version || echo "npm not available"
            pnpm --version || echo "pnpm not available"
            pm2 --version || echo "pm2 not available"

            echo ""
            echo "=== Git repo check ==="
            if [ -d "/home/ubuntu/mokkoji" ]; then
              cd /home/ubuntu/mokkoji
              echo "Directory exists!"
              pwd
              echo ""
              echo "Git status:"
              git status || echo "Not a git repository"
              echo ""
              echo "Git branches:"
              git branch -a || echo "Cannot list branches"
              echo ""
              echo "Current branch:"
              git branch --show-current || echo "Cannot determine current branch"
            else
              echo "/home/ubuntu/mokkoji does not exist!"
              echo "Searching for mokkoji directories..."
              find /home -name "*mokkoji*" -type d 2>/dev/null || echo "No mokkoji directories found"
            fi

            echo ""
            echo "=== PM2 status ==="
            pm2 list || echo "PM2 not running or no processes"

            echo ""
            echo "=== Environment variables ==="
            env | grep -i node || echo "No NODE env vars"
            env | grep -i path || echo "No PATH env vars"

            echo ""
            echo "=== Disk space ==="
            df -h

            echo ""
            echo "=== Debug complete ==="
