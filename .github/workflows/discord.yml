name: GitHub ‚Üí Discord (Embed Style)

on:
  issues:
    types: [opened, reopened]
  pull_request:
    types: [opened, reopened]
  push:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          EVENT_NAME: ${{ github.event_name }}

          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_URL: ${{ github.event.issue.html_url }}

          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_URL: ${{ github.event.pull_request.html_url }}

          PUSH_MESSAGE: ${{ github.event.head_commit.message }}
          PUSH_URL: ${{ github.event.compare }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          if ! command -v jq >/dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          COLOR=9807270
          TITLE=""
          DESC=""
          URL=""

          case "$EVENT_NAME" in
            issues)
              COLOR=15844367
              TITLE="üüß Issue: ${ISSUE_TITLE:-"(no title)"}"
              DESC="${ISSUE_BODY:-""}"
              URL="${ISSUE_URL:-""}"
              ;;
            pull_request)
              COLOR=3066993
              TITLE="üü© Pull Request: ${PR_TITLE:-"(no title)"}"
              DESC="${PR_BODY:-""}"
              URL="${PR_URL:-""}"
              ;;
            push)
              COLOR=3447003
              TITLE="üü¶ Push to ${REF_NAME}"
              DESC="${PUSH_MESSAGE:-""}"
              URL="${PUSH_URL:-""}"
              ;;
          esac

          # Discord embed description(ÏµúÎåÄ 4096Ïûê) Î≥¥Ìò∏Ïö© Í∞ÑÎã® Ìä∏Î¶º
          if [ "${#DESC}" -gt 4000 ]; then
            DESC="${DESC:0:4000}‚Ä¶"
          fi

          TS="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          PAYLOAD="$(jq -n \
            --arg title "$TITLE" \
            --arg desc "$DESC" \
            --arg url "$URL" \
            --arg ts "$TS" \
            --argjson color "$COLOR" \
            '{embeds: [{title: $title, description: $desc, url: $url, color: $color, footer: {text: "GitHub ‚Üí Discord"}, timestamp: $ts}]}' \
          )"

          # Ï†ÑÏÜ° + ÏÉÅÌÉúÏΩîÎìú Í≤ÄÏ¶ù
          http_code="$(curl -sS -o /tmp/resp.txt -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -X POST \
            --data "$PAYLOAD" \
            "$DISCORD_WEBHOOK_URL")"

          echo "Discord HTTP $http_code"
          if [ "$http_code" != "204" ]; then
            echo "Response body:"
            cat /tmp/resp.txt
            exit 1
          fi
