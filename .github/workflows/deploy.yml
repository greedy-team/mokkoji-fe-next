name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      env:
        description: dev or prod
        required: true
        default: dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            set -e
            APP_DIR="/var/www/mokkoji"

            # main에 push면 prod, 수동은 입력값
            if [ "${{ github.event_name }}" = "push" ]; then
              TARGET_ENV="prod"
            else
              TARGET_ENV="${{ github.event.inputs.env }}"
            fi

            if [ "$TARGET_ENV" = "prod" ]; then
              BRANCH="main"; APP_NAME="mokkoji-prod"; PORT=3000
              API_URL="${{ secrets.NEXT_PUBLIC_API_URL_PROD }}"
              NODE_ENV="production"; SENTRY="true"
            else
              BRANCH="dev";  APP_NAME="mokkoji-dev";  PORT=3001
              API_URL="${{ secrets.NEXT_PUBLIC_API_URL_DEV }}"
              NODE_ENV="development"; SENTRY="false"
            fi

            export PNPM_HOME="$HOME/.local/share/pnpm"
            export PATH="$PNPM_HOME:$PATH"

            cd "$APP_DIR"
            git fetch --all
            git checkout "$BRANCH"
            git pull --ff-only

            cat > .env.local <<EOF
NEXT_PUBLIC_API_URL=$API_URL
NEXT_PUBLIC_NODE_ENV=$NODE_ENV
NEXT_PUBLIC_SENTRY=$SENTRY
NEXT_PUBLIC_SENTRY_DSN=${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}
NEXT_PUBLIC_SENTRY_REPLAY_DSN=${{ secrets.NEXT_PUBLIC_SENTRY_REPLAY_DSN }}
NEXT_PUBLIC_CLARITY_ID=${{ secrets.NEXT_PUBLIC_CLARITY_ID }}
NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}
EOF

            if command -v pnpm >/dev/null 2>&1; then
              pnpm i --frozen-lockfile --prefer-offline
              pnpm build
              pm2 restart "$APP_NAME" || pm2 start "pnpm start -- -p $PORT" --name "$APP_NAME"
            else
              npm ci
              npm run build
              pm2 restart "$APP_NAME" || pm2 start "npm run start -- -p $PORT" --name "$APP_NAME"
            fi

            pm2 save
